<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Voice Call Test</title>
</head>
<body>
  <h2>ğŸ¤ Voice Call Room</h2>
  <p>Room: <b>demo-room</b></p>
  <audio id="remoteAudio" autoplay></audio>

  <script>
    const roomId = "demo-room";
    const userId = Math.random().toString(36).substring(2, 7);
    const wsUrl = "https://webrtc-signal-z7bp.onrender.com"; // ğŸ”§ replace this
    const ws = new WebSocket(wsUrl);

    let pc;
    let localStream;

    const log = (...args) => console.log("[LOG]", ...args);
    const warn = (...args) => console.warn("âš ï¸", ...args);

    ws.onopen = () => {
      log("âœ… Connected to signaling server");
      ws.send(JSON.stringify({ type: "join", roomId, userId }));
    };

    ws.onmessage = async (msg) => {
      const data = JSON.parse(msg.data);
      log("ğŸ“© Message:", data);

      switch (data.type) {
        case "ready":
          await setupPeer();
          if (data.role === "caller") {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            ws.send(JSON.stringify({ type: "offer", roomId, userId, payload: offer }));
          } else {
            log("ğŸ™ï¸ Callee mic ready");
          }
          break;

        case "offer":
          await setupPeer();
          await pc.setRemoteDescription(data.payload);
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          ws.send(JSON.stringify({ type: "answer", roomId, userId, payload: answer }));
          break;

        case "answer":
          await pc.setRemoteDescription(data.payload);
          break;

        case "ice":
          try {
            if (pc.remoteDescription) {
              await pc.addIceCandidate(data.payload);
            } else {
              warn("ICE error: remoteDescription is null");
            }
          } catch (e) {
            warn("ICE error:", e);
          }
          break;

        case "user-left":
          log("ğŸ‘‹ User left the room");
          break;
      }
    };

    async function setupPeer() {
      if (pc) return;

      pc = new RTCPeerConnection({
        iceServers: [
          { urls: ["stun:stun.l.google.com:19302", "stun:stun1.l.google.com:19302"] },
          { urls: ["stun:global.stun.twilio.com:3478"] }
        ]
      });
      
      pc.onicecandidate = (event) => {
        if (event.candidate) {
          ws.send(JSON.stringify({ type: "ice", roomId, userId, payload: event.candidate }));
        }
      };

      pc.ontrack = (event) => {
        log("ğŸ§ Received remote audio stream");
        document.getElementById("remoteAudio").srcObject = event.streams[0];
      };

      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        log("ğŸ™ï¸ Microphone access granted");
      } catch (err) {
        warn("ğŸ™ï¸ Mic error:", err);
      }
    }
  </script>
</body>
</html>