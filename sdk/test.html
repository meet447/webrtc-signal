<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>VoiceSignal Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-gray-900 text-gray-100 min-h-screen">
    <header class="bg-gray-800 py-4 px-6 text-xl font-bold text-center text-blue-400">
      üéß VoiceSignal Dashboard
    </header>

    <div class="container mx-auto px-4 py-6">
      <!-- Device Selection -->
      <div class="bg-gray-800 rounded-xl p-4 shadow-lg mb-6">
        <h3 class="text-lg font-semibold mb-3 text-center text-blue-400">Device Selection</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Microphone</label>
            <select id="audioDeviceSelect" class="w-full bg-gray-700 text-white rounded p-2">
              <option>Loading devices...</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Camera</label>
            <select id="videoDeviceSelect" class="w-full bg-gray-700 text-white rounded p-2">
              <option>Loading devices...</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Controls Section -->
      <div class="flex flex-wrap gap-3 justify-center mb-6">
        <button id="toggleMicBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
          Mute Mic
        </button>
        <button id="toggleCamBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition">
          Disable Camera
        </button>
        <button id="leaveBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition">
          Leave Room
        </button>
      </div>

      <!-- Status Section -->
      <div id="status" class="text-center text-yellow-400 mb-6">
        Connecting...
      </div>

      <!-- Media Containers -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Local Video -->
        <div class="bg-gray-800 rounded-xl p-4 shadow-lg">
          <h3 class="text-lg font-semibold mb-3 text-center text-blue-400">You</h3>
          <div class="aspect-video bg-gray-700 rounded-lg overflow-hidden">
            <video id="localVideo" autoplay muted playsinline class="w-full h-full object-cover"></video>
          </div>
          <div class="mt-2 text-center text-sm text-gray-400">
            <span id="localMicStatus" class="text-green-400">üéôÔ∏è Mic On</span>
            <span class="mx-2">|</span>
            <span id="localCamStatus" class="text-green-400">üì∑ Cam On</span>
          </div>
        </div>

        <!-- Remote Videos Container -->
        <div class="bg-gray-800 rounded-xl p-4 shadow-lg">
          <h3 class="text-lg font-semibold mb-3 text-center text-purple-400">Participants</h3>
          <div id="remoteVideosContainer" class="space-y-4">
            <div class="text-center text-gray-500 py-8">
              Waiting for participants...
            </div>
          </div>
        </div>
      </div>

      <!-- Connection States -->
      <div class="mt-6 bg-gray-800 rounded-xl p-4 shadow-lg">
        <h3 class="text-lg font-semibold mb-3 text-center text-green-400">Connection States</h3>
        <div id="connectionStates" class="text-sm text-gray-400">
          <div class="text-center">No connections yet</div>
        </div>
      </div>

      <!-- Connection Info -->
      <div class="mt-6 bg-gray-800 rounded-xl p-4 shadow-lg">
        <h3 class="text-lg font-semibold mb-3 text-center text-green-400">Connection Info</h3>
        <div id="connectionInfo" class="text-sm text-gray-400 text-center">
          Not connected
        </div>
      </div>
    </div>

    <script type="module">
      import { VoiceSignal } from "./index.js";

      // DOM Elements
      const audioDeviceSelect = document.getElementById("audioDeviceSelect");
      const videoDeviceSelect = document.getElementById("videoDeviceSelect");
      const toggleMicBtn = document.getElementById("toggleMicBtn");
      const toggleCamBtn = document.getElementById("toggleCamBtn");
      const leaveBtn = document.getElementById("leaveBtn");
      const statusDiv = document.getElementById("status");
      const localVideo = document.getElementById("localVideo");
      const remoteVideosContainer = document.getElementById("remoteVideosContainer");
      const localMicStatus = document.getElementById("localMicStatus");
      const localCamStatus = document.getElementById("localCamStatus");
      const connectionInfo = document.getElementById("connectionInfo");
      const connectionStates = document.getElementById("connectionStates");

      // Generate random user ID
      const userId = Math.random().toString(36).substring(2, 7);
      
      // Initialize VoiceSignal SDK with TURN credentials (optional)
      const voice = new VoiceSignal({
        serverUrl: "wss://webrtc-signal-z7bp.onrender.com",
        roomId: "demo-room",
        userId,
        video: true,
        audio: true
      });

      // State variables
      let isMuted = false;
      let isCameraOff = false;
      let remoteVideos = {};

      // Populate device selection dropdowns
      async function populateDeviceSelectors() {
        try {
          // Request permissions first to get device labels
          const tempStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
          tempStream.getTracks().forEach(track => track.stop());
        } catch (err) {
          console.warn("Could not get initial stream for device labels:", err);
        }

        // Enumerate devices
        const devices = await voice.enumerateDevices();
        
        // Populate audio devices
        audioDeviceSelect.innerHTML = '';
        if (devices.audioInputs.length > 0) {
          devices.audioInputs.forEach(device => {
            const option = document.createElement('option');
            option.value = device.deviceId;
            option.textContent = device.label || `Microphone ${audioDeviceSelect.options.length + 1}`;
            audioDeviceSelect.appendChild(option);
          });
        } else {
          const option = document.createElement('option');
          option.textContent = 'No microphones found';
          option.disabled = true;
          audioDeviceSelect.appendChild(option);
        }

        // Populate video devices
        videoDeviceSelect.innerHTML = '';
        if (devices.videoInputs.length > 0) {
          devices.videoInputs.forEach(device => {
            const option = document.createElement('option');
            option.value = device.deviceId;
            option.textContent = device.label || `Camera ${videoDeviceSelect.options.length + 1}`;
            videoDeviceSelect.appendChild(option);
          });
        } else {
          const option = document.createElement('option');
          option.textContent = 'No cameras found';
          option.disabled = true;
          videoDeviceSelect.appendChild(option);
        }
      }

      // Update connection info display
      function updateConnectionInfo() {
        const peerCount = voice.getPeers().length;
        connectionInfo.innerHTML = `
          <div>User ID: <span class="text-blue-400">${userId}</span></div>
          <div>Connected Peers: <span class="text-green-400">${peerCount}</span></div>
          <div>Status: <span class="text-yellow-400">${voice.isConnected() ? 'Connected' : 'Disconnected'}</span></div>
        `;
      }

      // Update connection states display
      function updateConnectionStates() {
        const states = voice.getIceConnectionStates();
        if (Object.keys(states).length === 0) {
          connectionStates.innerHTML = '<div class="text-center">No connections yet</div>';
          return;
        }

        let statesHtml = '<div class="grid grid-cols-1 md:grid-cols-2 gap-2">';
        for (const [peerId, state] of Object.entries(states)) {
          let stateClass = 'text-gray-400';
          switch (state) {
            case 'connected':
              stateClass = 'text-green-400';
              break;
            case 'connecting':
              stateClass = 'text-yellow-400';
              break;
            case 'failed':
              stateClass = 'text-red-400';
              break;
            case 'disconnected':
              stateClass = 'text-orange-400';
              break;
          }
          
          statesHtml += `
            <div class="flex justify-between items-center bg-gray-700 p-2 rounded">
              <span>${peerId}</span>
              <span class="${stateClass}">${state}</span>
            </div>
          `;
        }
        statesHtml += '</div>';
        connectionStates.innerHTML = statesHtml;
      }

      // Create remote video element
      function createRemoteVideo(userId) {
        // Clear placeholder if it exists
        if (remoteVideosContainer.querySelector('.text-gray-500')) {
          remoteVideosContainer.innerHTML = '';
        }

        const container = document.createElement("div");
        container.id = `remote-container-${userId}`;
        container.className = "bg-gray-700 rounded-lg overflow-hidden aspect-video relative";
        
        const video = document.createElement("video");
        video.autoplay = true;
        video.playsinline = true;
        video.className = "w-full h-full object-cover";
        
        const label = document.createElement("div");
        label.className = "absolute bottom-2 left-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded";
        label.textContent = userId;
        
        container.appendChild(video);
        container.appendChild(label);
        remoteVideosContainer.appendChild(container);
        
        remoteVideos[userId] = video;
        updateConnectionInfo();
        updateConnectionStates();
      }

      // Remove remote video element
      function removeRemoteVideo(userId) {
        const container = document.getElementById(`remote-container-${userId}`);
        if (container) {
          container.remove();
          delete remoteVideos[userId];
        }
        
        // Show placeholder if no remote videos
        if (Object.keys(remoteVideos).length === 0) {
          remoteVideosContainer.innerHTML = '<div class="text-center text-gray-500 py-8">Waiting for participants...</div>';
        }
        
        updateConnectionInfo();
        updateConnectionStates();
      }

      // VoiceSignal SDK Events
      voice.on("joined", () => {
        statusDiv.textContent = `‚úÖ Joined as ${userId}`;
        statusDiv.className = "text-center text-green-400 mb-6";
        updateConnectionInfo();
      });

      voice.on("devicesEnumerated", (devices) => {
        console.log("Devices enumerated:", devices);
      });

      voice.on("audioDeviceChanged", (deviceId) => {
        console.log("Audio device changed to:", deviceId);
        // Update selected option in dropdown
        audioDeviceSelect.value = deviceId;
      });

      voice.on("videoDeviceChanged", (deviceId) => {
        console.log("Video device changed to:", deviceId);
        // Update selected option in dropdown
        videoDeviceSelect.value = deviceId;
      });

      voice.on("userJoined", (id) => {
        createRemoteVideo(id);
        console.log("üë§", id, "joined");
      });

      voice.on("userLeft", (id) => {
        removeRemoteVideo(id);
        console.log("üëã", id, "left");
      });

      voice.on("localStream", (stream) => {
        localVideo.srcObject = stream;
      });

      voice.on("stream", (stream, userId) => {
        if (remoteVideos[userId]) {
          remoteVideos[userId].srcObject = stream;
        }
      });

      voice.on("micMuted", (muted) => {
        localMicStatus.textContent = muted ? "üîá Mic Off" : "üéôÔ∏è Mic On";
        localMicStatus.className = muted ? "text-red-400" : "text-green-400";
      });

      voice.on("cameraToggled", (off) => {
        localCamStatus.textContent = off ? "üì∑ Cam Off" : "üì∑ Cam On";
        localCamStatus.className = off ? "text-red-400" : "text-green-400";
      });

      voice.on("connectionStateChange", (state, userId) => {
        console.log(`Connection state for ${userId}:`, state);
        updateConnectionStates();
      });

      voice.on("iceConnectionStateChange", (state, userId) => {
        console.log(`ICE connection state for ${userId}:`, state);
        updateConnectionStates();
      });

      voice.on("disconnected", () => {
        statusDiv.textContent = "‚ùå Disconnected from server";
        statusDiv.className = "text-center text-red-400 mb-6";
        updateConnectionInfo();
        updateConnectionStates();
      });

      voice.on("error", (error) => {
        statusDiv.textContent = `‚ùå Error: ${error.message}`;
        statusDiv.className = "text-center text-red-400 mb-6";
        console.error("SDK Error:", error);
      });

      // Device Selection Event Listeners
      audioDeviceSelect.addEventListener("change", async (e) => {
        const deviceId = e.target.value;
        if (deviceId) {
          await voice.switchAudioDevice(deviceId);
        }
      });

      videoDeviceSelect.addEventListener("change", async (e) => {
        const deviceId = e.target.value;
        if (deviceId) {
          await voice.switchVideoDevice(deviceId);
        }
      });

      // Button Event Listeners
      toggleMicBtn.addEventListener("click", () => {
        isMuted = !isMuted;
        voice.muteMic(isMuted);
        toggleMicBtn.textContent = isMuted ? "Unmute Mic" : "Mute Mic";
        toggleMicBtn.className = isMuted 
          ? "bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition" 
          : "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition";
      });

      toggleCamBtn.addEventListener("click", () => {
        isCameraOff = !isCameraOff;
        voice.toggleCamera(isCameraOff);
        toggleCamBtn.textContent = isCameraOff ? "Enable Camera" : "Disable Camera";
        toggleCamBtn.className = isCameraOff 
          ? "bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition" 
          : "bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition";
      });

      leaveBtn.addEventListener("click", () => {
        voice.leave();
        statusDiv.textContent = "‚ùå Left the room";
        statusDiv.className = "text-center text-red-400 mb-6";
        
        // Stop local video
        if (localVideo.srcObject) {
          const tracks = localVideo.srcObject.getTracks();
          tracks.forEach(track => track.stop());
          localVideo.srcObject = null;
        }
        
        // Clear remote videos
        Object.keys(remoteVideos).forEach(removeRemoteVideo);
        updateConnectionInfo();
        updateConnectionStates();
      });

      // Initialize
      populateDeviceSelectors();
      
      // Join the room
      await voice.join().catch(err => {
        statusDiv.textContent = `‚ùå Failed to join: ${err.message}`;
        statusDiv.className = "text-center text-red-400 mb-6";
      });
    </script>
  </body>
</html>